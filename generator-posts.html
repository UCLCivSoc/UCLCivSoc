<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Generator</title>
    <style>
        /* --- THEME & RESET --- */
        :root { 
            --bg: #121214;
            --surface: #1e1e24;
            --surface-hover: #272730;
            --border: #333;
            --primary: #F6BE00; 
            --primary-fg: #000;
            --text: #e1e1e6; 
            --text-muted: #a8a8b3;
            --accent-purple: #8257e5;
            --danger: #e83f5b;
            --radius: 8px;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; outline: none; }

        body { 
            background-color: var(--bg);
            color: var(--text); 
            font-family: var(--font-sans); 
            margin: 0; height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- NAVIGATION --- */
        .top-bar {
            height: 60px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; background: var(--surface);
            flex-shrink: 0; z-index: 10;
        }
        
        .nav-left a {
            color: var(--text-muted); text-decoration: none; font-size: 0.9rem; font-weight: 500;
            display: flex; align-items: center; gap: 8px; transition: color 0.2s;
        }
        .nav-left a:hover { color: var(--text); }

        .nav-tabs {
            display: flex; gap: 4px; background: var(--bg); padding: 4px; border-radius: var(--radius);
        }
        .tab-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 6px 16px; font-weight: 600; font-size: 0.85rem;
            cursor: pointer; border-radius: 4px; transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { background: var(--surface-hover); color: var(--text); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        
        .logout-btn {
            background: transparent; border: 1px solid var(--border); color: var(--text-muted); 
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;
        }
        .logout-btn:hover { border-color: var(--text-muted); color: var(--text); }

        /* --- MAIN LAYOUT --- */
        .workspace { display: flex; flex: 1; overflow: hidden; }

        /* Left Sidebar: Settings */
        .sidebar {
            width: 350px; background: var(--surface); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; overflow-y: auto; padding: 20px;
        }

        /* Center: Canvas/Builder (Only for 'Builder' tab) */
        .center-stage {
            flex: 1; background: var(--bg); overflow-y: auto; padding: 40px;
            display: flex; justify-content: center;
        }

        /* Right/Preview Area */
        .preview-stage {
            flex: 1; background: #000; overflow-y: hidden; border-left: 1px solid var(--border);
            display: flex; flex-direction: column;
        }

        /* --- FORMS & INPUTS --- */
        .form-group { margin-bottom: 20px; }
        label { 
            color: var(--text-muted); font-size: 0.75rem; font-weight: 600; 
            margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; 
        }
        
        input[type="text"], input[type="number"], input[type="date"], select, textarea { 
            background: var(--bg); border: 1px solid var(--border); color: var(--text); 
            padding: 10px 12px; border-radius: var(--radius); width: 100%; 
            font-family: inherit; font-size: 0.9rem; transition: border 0.2s;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); }

        .row { display: flex; gap: 15px; } 
        .row > div { flex: 1; }

        .checkbox-row { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.9rem; }
        input[type="checkbox"] { accent-color: var(--primary); width: 16px; height: 16px; }

        .section-title {
            color: var(--text); font-weight: 700; font-size: 0.95rem; 
            margin: 25px 0 15px 0; padding-bottom: 8px; border-bottom: 1px solid var(--border);
        }
        .section-title:first-child { margin-top: 0; }

        /* --- BLOCK BUILDER --- */
        .toolbar { 
            display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;
            position: sticky; top: 0; z-index: 5;
        }
        .tool-btn { 
            background: var(--surface); color: var(--text); border: 1px solid var(--border); 
            padding: 8px 16px; cursor: pointer; font-weight: 600; font-size: 0.85rem; border-radius: 20px; 
            display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .tool-btn:hover { background: var(--surface-hover); border-color: var(--text-muted); transform: translateY(-1px); }

        .block-list { max-width: 700px; width: 100%; margin: 0 auto; padding-bottom: 50px; }
        
        .block { 
            background: var(--surface); padding: 15px; border-radius: var(--radius); 
            border: 1px solid var(--border); margin-bottom: 15px; 
            position: relative; animation: slideUp 0.2s;
        }
        .block:hover { border-color: #444; }
        @keyframes slideUp { from { transform: translateY(5px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .block-header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; 
            padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .block-label { font-size: 0.7rem; font-weight: 700; color: var(--accent-purple); text-transform: uppercase; }
        
        .ctrl-actions { display: flex; gap: 4px; }
        .ctrl-btn { 
            width: 24px; height: 24px; border-radius: 4px; border: none; 
            background: rgba(255,255,255,0.05); color: var(--text-muted); cursor: pointer; 
            display: flex; justify-content: center; align-items: center; font-size: 0.8rem;
        }
        .ctrl-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .ctrl-del:hover { background: var(--danger); color: white; }

        /* --- PREVIEW PANEL --- */
        .preview-header {
            padding: 10px 20px; background: #000; border-bottom: 1px solid var(--border);
            display: flex; gap: 10px; justify-content: center;
        }
        .sub-tab { 
            background: transparent; border: none; color: #666; font-weight: bold; cursor: pointer; padding: 5px 10px;
        }
        .sub-tab.active { color: var(--primary); }

        .preview-content { flex: 1; overflow-y: auto; position: relative; }
        
        /* Visual Preview CSS (mimics site) */
        .vis-preview { background: white; min-height: 100%; color: #1c1c1c; padding: 40px; }
        .mock-title { font-size: 2.5rem; line-height: 1; font-weight: 900; color: #ddd; text-transform: uppercase; margin-bottom: 5px; }
        .mock-title span { color: #500778; }
        .mock-meta { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
        .mock-badge { background: #500778; color: white; padding: 4px 10px; border-radius: 4px; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; }
        .mock-body { font-size: 1.1rem; line-height: 1.6; color: #333; }
        .mock-body img { max-width: 100%; border-radius: 4px; margin: 10px 0; }
        
        /* Code Preview */
        #json-output { 
            width: 100%; height: 100%; background: #0d0d0d; color: #00ff9d; 
            border: none; padding: 20px; font-family: 'Courier New', monospace; resize: none; 
        }

        .publish-bar {
            padding: 15px; border-top: 1px solid var(--border); background: var(--surface);
            display: flex; flex-direction: column; gap: 10px;
        }
        .publish-btn { 
            width: 100%; padding: 14px; background: var(--primary); color: var(--primary-fg); 
            font-weight: 700; border: none; border-radius: var(--radius); cursor: pointer; 
            font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .publish-btn:hover { opacity: 0.9; }
        .publish-btn:disabled { background: #333; color: #666; cursor: not-allowed; }

        /* File Upload */
        .upload-wrapper { display: flex; gap: 10px; }
        .upload-btn { background: var(--surface-hover); border: 1px solid var(--border); color: var(--text); padding: 0 15px; cursor: pointer; border-radius: var(--radius); font-size: 0.85rem; white-space: nowrap; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

    </style>
    
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
</head>
<body>

    <div class="top-bar">
        <div class="nav-left">
            <a href="easygenerator.html">‚Üê Generator Hub</a>
        </div>
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchView('settings', this)">Settings</button>
            <button class="tab-btn" onclick="switchView('builder', this)">Builder</button>
            <button class="tab-btn" onclick="switchView('preview', this)">Publish</button>
        </div>
        <button onclick="logout()" class="logout-btn">Logout</button>
    </div>

    <div class="workspace">
        
        <!-- SIDEBAR: SETTINGS (Always visible on large screens? No, let's keep tabs for simplicity) -->
        <div id="view-settings" class="sidebar" style="width: 100%; max-width: 600px; margin: 0 auto; border:none; display:block;">
            
            <div class="section-title">General Info</div>
            <div class="row">
                <div style="flex:1;"><label>ID (Auto)</label><input type="number" id="inp-id" placeholder="Auto" oninput="updateJSON()"></div>
                <div style="flex:3;"><label>Title</label><input type="text" id="inp-title" placeholder="Event Title" oninput="updateJSON()"></div>
            </div>
            
            <div class="row" style="margin-top:15px;">
                <div><label>Display Date</label><input type="text" id="inp-date" placeholder="e.g. Oct 24, 2025" oninput="updateJSON()"></div>
                <div>
                    <label>Category</label>
                    <select id="inp-type" onchange="updateJSON()">
                        <option value="social">Social</option>
                        <option value="career">Career</option>
                        <option value="academic">Academic</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label>Card Summary</label>
                <textarea id="inp-summary" rows="3" placeholder="Short description for the card grid..." oninput="updateJSON()"></textarea>
            </div>

            <div class="section-title">Display Options</div>
            <div class="checkbox-row">
                <label class="checkbox-item"><input type="checkbox" id="inp-major" onchange="updateJSON()"> Major Card (Double Width)</label>
                <label class="checkbox-item"><input type="checkbox" id="inp-ultra" onchange="updateJSON()"> Ultra Major (Full Width Banner)</label>
            </div>

            <div class="form-group">
                <label>Background Image (Ultra Only)</label>
                <div class="upload-wrapper">
                    <input type="text" id="inp-bg" placeholder="Image URL..." oninput="updateJSON()">
                    <button class="upload-btn" onclick="document.getElementById('bg-file').click()">Upload</button>
                    <input type="file" id="bg-file" style="display:none" accept="image/*" onchange="uploadImage(this, 'inp-bg')">
                </div>
            </div>

            <div class="section-title">Event & Ticketing</div>
            <div class="form-group">
                <label>Event Date (Sorting)</label>
                <input type="date" id="inp-evdate" oninput="updateJSON()">
            </div>
            <div class="row">
                <div><label>Start Time</label><input type="text" id="inp-start" placeholder="18:00" oninput="updateJSON()"></div>
                <div><label>End Time</label><input type="text" id="inp-end" placeholder="21:00" oninput="updateJSON()"></div>
            </div>

            <div class="row" style="margin-top:15px;">
                <div>
                    <label>Ticket Label</label>
                    <select id="inp-ticket" onchange="updateJSON()">
                        <option value="">Hidden (No Label)</option>
                        <option value="On Sale">On Sale</option>
                        <option value="Selling Fast">Selling Fast</option>
                        <option value="Sold Out">Sold Out</option>
                    </select>
                </div>
                <div>
                    <label>Action Button</label>
                    <select id="inp-linktype" onchange="updateJSON()">
                        <option value="none">None</option>
                        <option value="su">SU Ticket Page</option>
                        <option value="ms">Microsoft Form</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" style="margin-top:15px;">
                <label>Link URL</label>
                <input type="text" id="inp-linkurl" placeholder="https://..." oninput="updateJSON()">
            </div>

            <div style="height:50px;"></div> <!-- Spacer -->
        </div>

        <!-- BUILDER VIEW -->
        <div id="view-builder" class="center-stage" style="display:none;">
            <div class="block-list">
                <div class="toolbar">
                    <button class="tool-btn" onclick="addBlock('p')"><span>¬∂</span> Text</button>
                    <button class="tool-btn" onclick="addBlock('h')"><span>H</span> Header</button>
                    <button class="tool-btn" onclick="addBlock('img')"><span>üñº</span> Image</button>
                    <button class="tool-btn" onclick="addBlock('list')"><span>‚â£</span> List</button>
                </div>
                <div id="block-container">
                    <div style="text-align:center; color:var(--text-muted); margin-top:50px; font-style:italic;">
                        Start building your post content...
                    </div>
                </div>
            </div>
        </div>

        <!-- PREVIEW/PUBLISH VIEW -->
        <div id="view-preview" class="preview-stage" style="display:none;">
            <div class="preview-header">
                <button class="sub-tab active" onclick="switchSubTab('vis', this)">Visual</button>
                <button class="sub-tab" onclick="switchSubTab('code', this)">JSON Data</button>
            </div>
            
            <div class="preview-content">
                <div id="pane-vis" class="vis-preview">
                    <!-- MOCKUP -->
                    <div id="prev-title-box"></div>
                    <div id="prev-meta" class="mock-meta"></div>
                    <div id="prev-body" class="mock-body"></div>
                </div>
                <div id="pane-code" style="display:none; height:100%;">
                    <textarea id="json-output" readonly></textarea>
                </div>
            </div>

            <div class="publish-bar">
                <button class="publish-btn" id="publish-btn" onclick="publishPost()">Publish to Database</button>
                <div id="pub-status" style="text-align:center; font-size:0.8rem; height:1rem;"></div>
            </div>
        </div>

    </div>

    <script>
        let db;
        checkAuth((user) => {
            db = firebase.firestore();
        });

        // VIEW MANAGER
        function switchView(id, btn) {
            // Hide all main containers
            document.getElementById('view-settings').style.display = 'none';
            document.getElementById('view-builder').style.display = 'none';
            document.getElementById('view-preview').style.display = 'none';
            
            // Show selected
            document.getElementById('view-' + id).style.display = (id === 'settings' ? 'block' : 'flex');
            
            // Reset tabs
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if(id === 'preview') updateJSON();
        }

        function switchSubTab(id, btn) {
            document.getElementById('pane-vis').style.display = 'none';
            document.getElementById('pane-code').style.display = 'none';
            document.getElementById('pane-' + id).style.display = (id === 'vis' ? 'block' : 'block');
            
            document.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- CLOUDINARY UPLOAD ---
        async function uploadImage(input, targetId, blockIndex = null) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            
            const btn = input.previousElementSibling;
            const originalText = btn.innerText;
            btn.innerText = "‚è≥";
            btn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CIVSOC_CONFIG.cloudinary.uploadPreset);

                const res = await fetch(`https://api.cloudinary.com/v1_1/${CIVSOC_CONFIG.cloudinary.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.secure_url) {
                    if (targetId) {
                        document.getElementById(targetId).value = data.secure_url;
                        updateJSON();
                    } else if (blockIndex !== null) {
                        updBlock(blockIndex, data.secure_url);
                    }
                }
            } catch(e) {
                console.error(e);
                alert("Upload failed");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // --- BLOCK LOGIC ---
        let blocks = [];
        
        function addBlock(type) {
            if(blocks.length === 0) document.getElementById('block-container').innerHTML = '';
            blocks.push({ type, val: type === 'list' ? [''] : '' });
            renderBlocks();
        }

        function renderBlocks() {
            const container = document.getElementById('block-container');
            container.innerHTML = '';
            blocks.forEach((b, i) => {
                let inner = '';
                if(b.type === 'p') inner = `<textarea rows="3" oninput="updBlock(${i}, this.value)" placeholder="Paragraph text...">${b.val}</textarea>`;
                else if(b.type === 'h') inner = `<input type="text" value="${b.val}" oninput="updBlock(${i}, this.value)" placeholder="Header title...">`;
                else if(b.type === 'img') {
                    inner = `
                    <div class="upload-wrapper">
                        <input type="text" value="${b.val}" oninput="updBlock(${i}, this.value)" placeholder="Image URL">
                        <button class="upload-btn" onclick="document.getElementById('img-file-${i}').click()">Upload</button>
                        <input type="file" id="img-file-${i}" style="display:none" accept="image/*" onchange="uploadImage(this, null, ${i})">
                    </div>`;
                }
                else if(b.type === 'list') {
                    b.val.forEach((item, li_i) => {
                        inner += `<div style="display:flex; gap:10px; margin-bottom:5px;"><input style="margin:0" value="${item}" oninput="updList(${i},${li_i},this.value)"><button class="ctrl-btn ctrl-del" onclick="delList(${i},${li_i})">-</button></div>`;
                    });
                    inner += `<button style="background:transparent; border:1px dashed var(--border); color:var(--text-muted); padding:8px; width:100%; margin-top:5px; cursor:pointer; border-radius:4px; font-size:0.8rem;" onclick="addList(${i})">+ Add Item</button>`;
                }

                const el = document.createElement('div');
                el.className = 'block';
                el.innerHTML = `
                    <div class="block-header">
                        <span class="block-label">${b.type}</span>
                        <div class="ctrl-actions">
                            <button class="ctrl-btn" onclick="moveBlock(${i},-1)">‚ñ≤</button>
                            <button class="ctrl-btn" onclick="moveBlock(${i},1)">‚ñº</button>
                            <button class="ctrl-btn ctrl-del" onclick="delBlock(${i})">‚úï</button>
                        </div>
                    </div>
                    ${inner}`;
                container.appendChild(el);
            });
        }

        function updBlock(i, v) { blocks[i].val = v; updateJSON(); }
        function updList(i, li, v) { blocks[i].val[li] = v; updateJSON(); }
        function addList(i) { blocks[i].val.push(''); renderBlocks(); }
        function delList(i, li) { blocks[i].val.splice(li, 1); renderBlocks(); }
        function delBlock(i) { blocks.splice(i, 1); renderBlocks(); }
        function moveBlock(i, dir) {
            if(i+dir < 0 || i+dir >= blocks.length) return;
            [blocks[i], blocks[i+dir]] = [blocks[i+dir], blocks[i]];
            renderBlocks();
        }

        // --- JSON & PREVIEW CORE ---
        function updateJSON() {
            const d = {
                id: document.getElementById('inp-id').value ? parseInt(document.getElementById('inp-id').value) : Date.now(),
                title: document.getElementById('inp-title').value || "TITLE",
                date: document.getElementById('inp-date').value || "Date",
                type: document.getElementById('inp-type').value,
                summary: document.getElementById('inp-summary').value,
                bg: document.getElementById('inp-bg').value,
                major: document.getElementById('inp-major').checked,
                ultra: document.getElementById('inp-ultra').checked,
                evDate: document.getElementById('inp-evdate').value,
                start: document.getElementById('inp-start').value,
                end: document.getElementById('inp-end').value,
                ticket: document.getElementById('inp-ticket').value,
                linkType: document.getElementById('inp-linktype').value,
                linkUrl: document.getElementById('inp-linkurl').value
            };

            // Build HTML
            let html = "";
            blocks.forEach(b => {
                if(!b.val) return;
                if(b.type === 'p') html += `<p>${b.val}</p>`;
                if(b.type === 'h') html += `<h3>${b.val}</h3>`;
                if(b.type === 'img') html += `<img src="${b.val}">`;
                if(b.type === 'list' && b.val.length) html += `<ul>${b.val.map(x=>`<li>${x}</li>`).join('')}</ul>`;
            });

            // --- Visual Preview Update ---
            const tHTML = d.title.split(' ').map(w => 
                `<div style="display:inline-block; margin-right:8px;"><span style="color:#500778">${w.charAt(0)}</span>${w.slice(1)}</div>`
            ).join('');
            document.getElementById('prev-title-box').innerHTML = `<h1 class="mock-title">${tHTML}</h1>`;
            
            let metaHTML = `<span class="mock-badge">${d.type}</span>`;
            if(d.evDate) metaHTML += `<span style="font-weight:700; color:#888; font-size:0.8rem;">üìÖ ${d.evDate} ${d.start?'‚Ä¢ '+d.start:''}</span>`;
            
            // Preview the button
            if (d.linkType !== 'none') {
                 metaHTML += `<span style="margin-left:auto; font-weight:bold; color:${d.linkType === 'ms' ? '#00e676' : '#F6BE00'}">
                    [Button: ${d.linkType === 'ms' ? 'Forms' : 'SU'}]
                 </span>`;
            }
            
            document.getElementById('prev-meta').innerHTML = metaHTML;
            document.getElementById('prev-body').innerHTML = html || "<i style='color:#ccc'>Content preview...</i>";

            // --- Data Object Construction ---
            let obj = {
                id: d.id,
                date: d.date,
                title: d.title,
                type: d.type,
                summary: d.summary,
                content: html,
                createdAt: new Date().toISOString()
            };
            if(d.evDate) obj.eventDate = d.evDate;
            if(d.start) obj.startTime = d.start;
            if(d.end) obj.endTime = d.end;
            if(d.ultra) { obj.isUltraMajor = true; obj.major = true; if(d.bg) obj.backgroundImage = d.bg; }
            else if(d.major) obj.major = true;
            
            // New Ticketing Logic
            if(d.ticket) { 
                obj.hasTickets = true; 
                obj.ticketStatus = d.ticket; 
            }
            if(d.linkType && d.linkType !== 'none') {
                obj.linkType = d.linkType;
                obj.ticketLink = d.linkUrl;
            }

            document.getElementById('json-output').value = JSON.stringify(obj, null, 2);
        }

        async function publishPost() {
            const btn = document.getElementById('publish-btn');
            const status = document.getElementById('pub-status');
            const json = document.getElementById('json-output').value;
            
            if(!json) return;
            
            btn.disabled = true;
            btn.innerText = "PUBLISHING...";
            status.innerText = "";
            
            try {
                const data = JSON.parse(json);
                await db.collection("posts").add(data);
                
                status.innerText = "SUCCESS! POST PUBLISHED.";
                status.style.color = "#00e676";
                btn.innerText = "PUBLISHED";
                setTimeout(() => { btn.innerText = "Publish to Database"; btn.disabled = false; }, 3000);
            } catch(e) {
                console.error(e);
                status.innerText = "ERROR: " + e.message;
                status.style.color = "#ff4444";
                btn.innerText = "TRY AGAIN";
                btn.disabled = false;
            }
        }
        
        // Initial init
        updateJSON();
    </script>
</body>
</html>