<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Generator</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- THEME --- */
        :root { 
            --bg-dark: #0f0f13; 
            --panel: rgba(30, 30, 35, 0.6);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #F6BE00; 
            --purple: #500778;
            --text: #eee; 
            --text-muted: #aaa;
        }

        body { 
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 10% 20%, rgba(80, 7, 120, 0.1) 0%, transparent 40%);
            color: var(--text); font-family: 'Helvetica Neue', sans-serif; 
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- NAVIGATION --- */
        .nav-bar {
            display: flex; justify-content: center; padding: 20px;
            background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px); z-index: 100;
        }
        .nav-pills {
            display: flex; background: rgba(255,255,255,0.05); 
            border-radius: 50px; padding: 5px; gap: 5px; border: 1px solid var(--border);
        }
        .tab-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 10px 25px; font-weight: 700; font-size: 0.85rem;
            cursor: pointer; border-radius: 30px; transition: all 0.3s ease;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .tab-btn:hover { color: white; }
        .tab-btn.active { background: var(--accent); color: #000; box-shadow: 0 4px 15px rgba(246, 190, 0, 0.3); }
        
        .logout-btn {
            position: absolute; right: 20px; top: 20px;
            background: transparent; border: 1px solid #444; color: #888; 
            padding: 5px 10px; border-radius: 4px; cursor: pointer;
        }

        /* --- LAYOUT --- */
        .view-section { display: none; flex-grow: 1; overflow-y: auto; padding: 40px; }
        .view-section.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .container-limit { max-width: 900px; margin: 0 auto; }

        /* --- FORMS --- */
        .glass-panel {
            background: var(--panel); border: 1px solid var(--border);
            border-radius: 16px; padding: 30px; margin-bottom: 30px;
            backdrop-filter: blur(20px); box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        label { color: var(--accent); font-weight: 800; font-size: 0.75rem; margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, select, textarea { 
            background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; 
            padding: 14px; border-radius: 8px; width: 100%; margin-bottom: 20px; 
            font-family: inherit; box-sizing: border-box; font-size: 0.95rem; transition: 0.2s;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--accent); outline: none; background: rgba(0,0,0,0.5); }

        .row { display: flex; gap: 20px; } .row > div { flex: 1; }

        /* CHECKBOXES */
        .checkbox-group { display: flex; gap: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border); }
        .checkbox-group label { margin: 0; display: flex; align-items: center; gap: 10px; color: white; cursor: pointer; text-transform: none; font-size: 0.9rem; }
        input[type="checkbox"] { width: 18px; height: 18px; margin: 0; accent-color: var(--accent); }

        /* --- BLOCKS --- */
        .toolbar { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 25px; 
            position: sticky; top: -40px; background: var(--bg-dark); padding: 15px 0; z-index: 10; border-bottom: 1px solid var(--border);
        }
        .tool-btn { 
            background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--border); 
            padding: 12px; cursor: pointer; font-weight: 700; font-size: 0.8rem; border-radius: 8px; 
            transition: 0.2s; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .tool-btn:hover { background: var(--accent); color: black; transform: translateY(-2px); border-color: var(--accent); }

        .block { 
            background: #18181c; padding: 20px; border-radius: 12px; 
            border-left: 4px solid var(--accent); margin-bottom: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .block-type { font-weight: 900; color: #555; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .ctrl-btn { 
            width: 28px; height: 28px; border-radius: 6px; border: 1px solid #333; 
            background: #222; color: #888; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; 
        }
        .ctrl-btn:hover { background: white; color: black; }
        .ctrl-del:hover { background: #ff4444; border-color: #ff4444; color: white; }

        /* --- PREVIEW --- */
        .preview-pane { display: none; background: white; color: black; min-height: 600px; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .preview-pane.active { display: block; }

        .mock-layout { display: flex; height: 600px; }
        .mock-left { width: 35%; background: #f9f9f9; padding: 40px; border-right: 1px solid #eee; display: flex; flex-direction: column; justify-content: center; }
        .mock-right { width: 65%; padding: 50px; overflow-y: auto; background: white; }
        
        .mock-title { font-size: 2.8rem; line-height: 0.95; font-weight: 900; color: #e0e0e0; text-transform: uppercase; word-break: break-word; }
        .mock-meta { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        #json-output { width: 100%; height: 500px; background: #08080a; color: #00ff9d; font-family: 'Courier New', monospace; border: 1px solid #333; padding: 25px; border-radius: 12px; resize: none; font-size: 0.9rem; line-height: 1.5; }
        .copy-btn { width: 100%; padding: 18px; background: var(--accent); color: black; font-weight: 900; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; transition: transform 0.2s; }
        .copy-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(246, 190, 0, 0.4); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .upload-btn { background: #222; border: 1px solid #444; color: white; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; margin-top: 5px; }
        .upload-btn:hover { background: #333; }
    </style>
    
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
</head>
<body>

    <nav class="nav-bar">
        <a href="easygenerator.html" style="position: absolute; left: 20px; top: 20px; color: #888; text-decoration: none;">‚Üê Return to Hub</a>
        <div class="nav-pills">
            <button class="tab-btn active" onclick="switchMainTab('settings', this)">1. Details</button>
            <button class="tab-btn" onclick="switchMainTab('blocks', this)">2. Builder</button>
            <button class="tab-btn" onclick="switchMainTab('preview', this)">3. Publish</button>
        </div>
        <button onclick="logout()" class="logout-btn">Logout</button>
    </nav>

    <div id="view-settings" class="view-section active">
        <div class="container-limit">
            <div class="glass-panel">
                <div class="row">
                    <!-- ID is auto-gen by Firebase mostly, but keeping for reference or custom ID if needed -->
                    <div style="flex:1;"><label>Unique ID (Optional)</label><input type="number" id="inp-id" value="" placeholder="Auto" oninput="updateJSON()"></div>
                    <div style="flex:3;"><label>Card Title</label><input type="text" id="inp-title" placeholder="Event Title" oninput="updateJSON()"></div>
                </div>

                <div class="row">
                    <div><label>Date (Display)</label><input type="text" id="inp-date" placeholder="Dec 05, 2025" oninput="updateJSON()"></div>
                    <div><label>Category</label>
                        <select id="inp-type" onchange="updateJSON()">
                            <option value="social">Social</option>
                            <option value="career">Career</option>
                            <option value="academic">Academic</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>

                <label>Summary (Front of Card)</label>
                <textarea id="inp-summary" rows="3" placeholder="Short description visible on the grid..." oninput="updateJSON()"></textarea>

                <div class="checkbox-group">
                    <label><input type="checkbox" id="inp-major" onchange="updateJSON()"> Major Card (2x Width)</label>
                    <label><input type="checkbox" id="inp-ultra" onchange="updateJSON()"> Ultra Major (Full Width Banner)</label>
                </div>
                
                <label>Background Image (For Ultra Major)</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="inp-bg" placeholder="Image URL..." oninput="updateJSON()">
                    <button class="upload-btn" onclick="document.getElementById('bg-file').click()">Upload</button>
                    <input type="file" id="bg-file" style="display:none" accept="image/*" onchange="uploadImage(this, 'inp-bg')">
                </div>
            </div>

            <div class="glass-panel">
                <h3 style="color:white; margin:0 0 20px 0; border-bottom:1px solid var(--border); padding-bottom:10px;">Calendar & Ticketing</h3>

                <label>Event Date (YYYY-MM-DD)</label>
                <input type="date" id="inp-evdate" oninput="updateJSON()">

                <div class="row">
                    <div><label>Start Time (24h)</label><input type="text" id="inp-start" placeholder="18:00" oninput="updateJSON()"></div>
                    <div><label>End Time (24h)</label><input type="text" id="inp-end" placeholder="21:00" oninput="updateJSON()"></div>
                </div>

                <label>Ticket Status</label>
                <select id="inp-ticket" onchange="updateJSON()">
                    <option value="">No Tickets</option>
                    <option value="On Sale">On Sale</option>
                    <option value="Selling Fast">Selling Fast</option>
                    <option value="Sold Out">Sold Out</option>
                </select>
            </div>
        </div>
    </div>

    <div id="view-blocks" class="view-section">
        <div class="container-limit">
            <div class="toolbar">
                <button class="tool-btn" onclick="addBlock('p')"><span>¬∂</span> Text</button>
                <button class="tool-btn" onclick="addBlock('h')"><span>H</span> Header</button>
                <button class="tool-btn" onclick="addBlock('img')"><span>üñº</span> Image</button>
                <button class="tool-btn" onclick="addBlock('list')"><span>‚â£</span> List</button>
            </div>
            <div id="block-container">
                <div style="text-align:center; color:#555; margin-top:100px; font-style:italic;">
                    Select a block type above to start building content.
                </div>
            </div>
        </div>
    </div>

    <div id="view-preview" class="view-section">
        <div class="container-limit" style="max-width: 1000px;">
            
            <div style="display:flex; justify-content:center; margin-bottom:30px;">
                <div class="nav-pills">
                    <button class="tab-btn active" onclick="switchSubTab('vis', this)">Visual Preview</button>
                    <button class="tab-btn" onclick="switchSubTab('code', this)">Data Object</button>
                </div>
            </div>

            <div id="pane-vis" class="preview-pane active">
                <div class="mock-layout">
                    <div class="mock-left">
                        <button style="align-self: flex-start; margin-bottom: 20px; padding: 8px 18px; border-radius: 20px; border:1px solid #ddd; background:white; font-weight:bold; color:#555;">‚Üê Back</button>
                        <div id="prev-title-box"></div>
                    </div>
                    <div class="mock-right">
                        <div class="mock-meta" id="prev-meta"></div>
                        <div class="article-body" id="prev-body"></div>
                    </div>
                </div>
            </div>

            <div id="pane-code" class="preview-pane" style="background:transparent; box-shadow:none;">
                <textarea id="json-output" readonly></textarea>
                <button class="copy-btn" id="publish-btn" onclick="publishPost()">PUBLISH TO SITE</button>
                <div id="pub-status" style="text-align:center; margin-top:10px; font-weight:bold;"></div>
            </div>

        </div>
    </div>

    <script>
        // --- AUTH & DB ---
        let db;
        checkAuth((user) => {
            db = firebase.firestore();
        });

        // --- NAVIGATION ---
        function switchMainTab(id, btn) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-pills .tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            btn.classList.add('active');
            updateJSON(); 
        }

        function switchSubTab(id, btn) {
            document.querySelectorAll('.preview-pane').forEach(el => el.classList.remove('active'));
            const parent = btn.parentElement;
            Array.from(parent.children).forEach(c => c.classList.remove('active'));
            document.getElementById('pane-' + id).classList.add('active');
            btn.classList.add('active');
        }

        // --- CLOUDINARY UPLOAD ---
        async function uploadImage(input, targetId, blockIndex = null) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            
            const btn = input.previousElementSibling;
            const originalText = btn.innerText;
            btn.innerText = "‚è≥";
            btn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CIVSOC_CONFIG.cloudinary.uploadPreset);

                const res = await fetch(`https://api.cloudinary.com/v1_1/${CIVSOC_CONFIG.cloudinary.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.secure_url) {
                    if (targetId) {
                        document.getElementById(targetId).value = data.secure_url;
                        updateJSON();
                    } else if (blockIndex !== null) {
                        updBlock(blockIndex, data.secure_url);
                    }
                }
            } catch(e) {
                console.error(e);
                alert("Upload failed");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // --- BLOCK LOGIC ---
        let blocks = [];
        
        function addBlock(type) {
            if(blocks.length === 0) document.getElementById('block-container').innerHTML = '';
            blocks.push({ type, val: type === 'list' ? [''] : '' });
            renderBlocks();
        }

        function renderBlocks() {
            const container = document.getElementById('block-container');
            container.innerHTML = '';
            blocks.forEach((b, i) => {
                let inner = '';
                if(b.type === 'p') inner = `<textarea rows="3" oninput="updBlock(${i}, this.value)" placeholder="Paragraph text...">${b.val}</textarea>`;
                else if(b.type === 'h') inner = `<input type="text" value="${b.val}" oninput="updBlock(${i}, this.value)" placeholder="Header title...">`;
                else if(b.type === 'img') {
                    inner = `
                    <div style="display:flex; gap:10px;">
                        <input type="text" value="${b.val}" oninput="updBlock(${i}, this.value)" placeholder="Image URL">
                        <button class="upload-btn" onclick="document.getElementById('img-file-${i}').click()">Upload</button>
                        <input type="file" id="img-file-${i}" style="display:none" accept="image/*" onchange="uploadImage(this, null, ${i})">
                    </div>`;
                }
                else if(b.type === 'list') {
                    b.val.forEach((item, li_i) => {
                        inner += `<div style="display:flex; gap:10px; margin-bottom:5px;"><input style="margin:0" value="${item}" oninput="updList(${i},${li_i},this.value)"><button class="ctrl-btn ctrl-del" onclick="delList(${i},${li_i})">-</button></div>`;
                    });
                    inner += `<button style="background:rgba(255,255,255,0.05); color:#aaa; border:1px dashed #444; padding:8px; width:100%; margin-top:5px; cursor:pointer; border-radius:4px;" onclick="addList(${i})">+ Add Item</button>`;
                }

                const el = document.createElement('div');
                el.className = 'block';
                el.innerHTML = `
                    <div class="block-header">
                        <span class="block-type">${b.type}</span>
                        <div style="display:flex; gap:5px;">
                            <button class="ctrl-btn" onclick="moveBlock(${i},-1)">‚ñ≤</button>
                            <button class="ctrl-btn" onclick="moveBlock(${i},1)">‚ñº</button>
                            <button class="ctrl-btn ctrl-del" onclick="delBlock(${i})">‚úï</button>
                        </div>
                    </div>
                    ${inner}`;
                container.appendChild(el);
            });
        }

        function updBlock(i, v) { blocks[i].val = v; renderBlocks(); updateJSON(); }
        function updList(i, li, v) { blocks[i].val[li] = v; }
        function addList(i) { blocks[i].val.push(''); renderBlocks(); }
        function delList(i, li) { blocks[i].val.splice(li, 1); renderBlocks(); }
        function delBlock(i) { blocks.splice(i, 1); renderBlocks(); }
        function moveBlock(i, dir) {
            if(i+dir < 0 || i+dir >= blocks.length) return;
            [blocks[i], blocks[i+dir]] = [blocks[i+dir], blocks[i]];
            renderBlocks();
        }

        // --- JSON & PREVIEW CORE ---
        function updateJSON() {
            const d = {
                id: document.getElementById('inp-id').value ? parseInt(document.getElementById('inp-id').value) : Date.now(),
                title: document.getElementById('inp-title').value || "TITLE",
                date: document.getElementById('inp-date').value || "Date",
                type: document.getElementById('inp-type').value,
                summary: document.getElementById('inp-summary').value,
                bg: document.getElementById('inp-bg').value,
                major: document.getElementById('inp-major').checked,
                ultra: document.getElementById('inp-ultra').checked,
                evDate: document.getElementById('inp-evdate').value,
                start: document.getElementById('inp-start').value,
                end: document.getElementById('inp-end').value,
                ticket: document.getElementById('inp-ticket').value
            };

            let html = "";
            blocks.forEach(b => {
                if(!b.val) return;
                if(b.type === 'p') html += `<p>${b.val}</p>`;
                if(b.type === 'h') html += `<h3>${b.val}</h3>`;
                if(b.type === 'img') html += `<img src="${b.val}">`;
                if(b.type === 'list' && b.val.length) html += `<ul>${b.val.map(x=>`<li>${x}</li>`).join('')}</ul>`;
            });

            // Preview Render
            const tHTML = d.title.split(' ').map(w => 
                `<div class="mock-title"><span style="color:#500778">${w.charAt(0)}</span>${w.slice(1)}</div>`
            ).join('');
            document.getElementById('prev-title-box').innerHTML = tHTML;
            
            let metaHTML = `<span style="background:#500778; color:white; padding:6px 14px; border-radius:4px; font-weight:800; font-size:0.75rem; text-transform:uppercase; letter-spacing:1px;">${d.type}</span>`;
            if(d.evDate) metaHTML += `<span style="font-weight:700; color:#888; font-size:0.9rem;">üìÖ ${d.evDate} ${d.start?'‚Ä¢ '+d.start:''}</span>`;
            document.getElementById('prev-meta').innerHTML = metaHTML;

            document.getElementById('prev-body').innerHTML = html || "<i style='color:#ccc'>No content yet...</i>";

            // Data Object Construction
            let obj = {
                id: d.id,
                date: d.date,
                title: d.title,
                type: d.type,
                summary: d.summary,
                content: html,
                createdAt: new Date().toISOString()
            };
            if(d.evDate) obj.eventDate = d.evDate;
            if(d.start) obj.startTime = d.start;
            if(d.end) obj.endTime = d.end;
            if(d.ultra) { obj.isUltraMajor = true; obj.major = true; if(d.bg) obj.backgroundImage = d.bg; }
            else if(d.major) obj.major = true;
            if(d.ticket) { obj.hasTickets = true; obj.ticketStatus = d.ticket; }

            document.getElementById('json-output').value = JSON.stringify(obj, null, 2);
        }

        async function publishPost() {
            const btn = document.getElementById('publish-btn');
            const status = document.getElementById('pub-status');
            const json = document.getElementById('json-output').value;
            
            if(!json) return;
            
            btn.disabled = true;
            btn.innerText = "PUBLISHING...";
            status.innerText = "";
            
            try {
                const data = JSON.parse(json);
                // Use a dedicated collection for dynamic posts
                await db.collection("posts").add(data);
                
                status.innerText = "SUCCESS! POST PUBLISHED.";
                status.style.color = "#00e676";
                btn.innerText = "PUBLISHED";
            } catch(e) {
                console.error(e);
                status.innerText = "ERROR: " + e.message;
                status.style.color = "#ff4444";
                btn.innerText = "TRY AGAIN";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>